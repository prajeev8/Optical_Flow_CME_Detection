# Optical_Flow_CME_Detection

This project processes coronal mass ejection (CME) images stored in FITS files(These are downloaded and saved with the folder named with the date), calculates the optical flow, and visualizes the velocity vectors and magnitude heatmaps.

## Table of Contents
- [Overview](#overview)
- [File Descriptions](#file-descriptions)
  - [Difference_images.py](#1-Difference_imagespy)
  - [Algorithm.py](#2-Algorithmpy)
- [Usage](#usage)
  - [Generate Difference Images](#generate-difference-images)
  - [Perform Optical Flow Analysis](#perform-optical-flow-analysis)
- [Dependencies](#dependencies)
- [Conclusion](#conclusion)

## Overview
This project is designed to process solar observation data captured in FITS format, extract features, and analyze them using optical flow methods. The workflow consists of two Python scripts:

- **Difference_images.py**: Processes FITS files, normalizes the data, and creates difference images.
- **Algorithm.py**: Takes the difference images generated from the first script, reduces noise, and computes the velocity magnitudes and flow vectors, visualizing them on a heatmap and the original frames.

## File Descriptions

### 1. `Difference_images.py`
This script is responsible for:

- **Loading FITS files**: It reads all `.fts` files from a specified directory, processes each file to normalize and subtract the background.
- **Creating Difference Images**: It generates difference images by subtracting consecutive frames, applying a circular mask to exclude the solar disk, and saving the results as PNG files.

**Key Functions:**
- `open_fits_file(fits_data)`: Reads FITS files, normalizes them, and subtracts the background.
- `create_circular_mask(shape, center, radius)`: Creates a circular mask to exclude certain regions of the image.
- `create_difference_imgs(images, headers, date)`: Generates difference images and saves them as PNG files.

**Inputs:**
- `fits_data`: Directory containing the FITS files.
- `date`: Date of the solar event for naming the output folder.

**Outputs:**
- Difference images saved in the `{date}_difference_images` folder.

### 2. `Algorithm.py`
This script uses the difference images produced by `difference_images.py` to:

- **Reduce noise**: Applies noise reduction techniques to the images.
- **Compute Optical Flow**: Calculates the flow of features between frames, extracting the magnitude and direction of movement.
- **Visualize the Results**: Generates heatmaps of velocity magnitudes and overlays flow vectors on the original images, saving these visualizations.

**Key Functions:**
- `load_frames_from_folder(folder_path)`: Loads difference images from a folder.
- `reduce_noise(img)`: Applies noise reduction to an image.
- `compute_optical_flow_and_magnitude(frames, x_value, y_value, width, height)`: Computes the optical flow between consecutive frames.
- `plot_velocity_heatmap_with_quiver(magnitude, u, v, date, step, frame_number)`: Creates a heatmap of velocity magnitudes with quiver plots of flow vectors.
- `plot_velocity_vectors_on_original_frames(frames, magnitudes, u_list, v_list, date, step, x_value, y_value)`: Overlays velocity vectors on the original frames.

**Inputs:**
- `frames_folder`: Folder containing the difference images generated by `difference_images.py`.
- `date`: Date of the solar event for naming the output folders.

**Outputs:**
- Velocity heatmaps saved in the `{date}_intensity` folder.
- Frames with overlaid velocity vectors saved in the `frames_with_vectors_{date}` folder.

## Usage

### Generate Difference Images
1. Place your FITS files in a directory (e.g., `folder_with_solar_fits_data`).
2. Set the `fits_data` and `date` variables in `difference_images.py`.
3. Run the script:
    ```bash
    python difference_images.py
    ```
4. This will create a folder named `{date}_difference_images` with the generated difference images.

### Perform Optical Flow Analysis
1. Ensure the `frames_folder` and `date` variables in `optical_flow_analysis.py` correspond to the output folder from the previous step.
2. Run the script:
    ```bash
    python optical_flow_analysis.py
    ```
3. The script will output velocity heatmaps and frames with overlaid vectors in folders named `{date}_intensity` and `frames_with_vectors_{date}`.

## Dependencies
- Python 3.x
- `astropy`
- `numpy`
- `opencv-python`
- `matplotlib`

You can install the required Python packages using:
```bash
pip install astropy numpy opencv-python matplotlib
```

##Conclusion
This workflow allows for effective processing and analysis of solar observation data, enabling the visualization of coronal mass ejections (CMEs) and other solar phenomena through optical flow techniques. By following the outlined steps, you can generate and analyze difference images to study the dynamics of solar events.
